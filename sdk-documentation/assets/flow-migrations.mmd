%%{init: {"theme": "base"}}%%
flowchart TD
  %% File-based SQL migrations (Warlot SDK Migrator.Up)

  classDef op fill:#E8F5E9,stroke:#2E7D32,stroke-width:1px,color:#1B5E20
  classDef io fill:#E3F2FD,stroke:#1565C0,stroke-width:1px,color:#0D47A1
  classDef dec fill:#FFF3E0,stroke:#F57C00,stroke-width:1px,color:#E65100
  classDef action fill:#FAFAFA,stroke:#616161,stroke-width:1px,color:#212121
  classDef note fill:#FFFDE7,stroke:#FBC02D,color:#5D4037
  classDef err fill:#FFEBEE,stroke:#C62828,stroke-width:1px,color:#B71C1C

  A[Start]:::op --> B["Ensure migrations table"]:::io
  B --> C["Read directory, select SQL files, sort ascending"]:::action
  C --> D["Load applied ids from ledger"]:::io

  D --> E{"Files remaining?"}:::dec
  E -- "No" --> X["No-op, return applied list"]:::op
  E -- "Yes" --> F["Iterate files in order"]:::action

  F --> G{"Already applied?"}:::dec
  G -- "Yes" --> F1["Skip and continue"]:::action --> F
  G -- "No" --> H["Read file content"]:::io
  H --> I["Execute SQL (idempotency header set)"]:::io
  I --> J{"Execution successful?"}:::dec

  J -- "Yes" --> K["Insert into ledger with timestamp"]:::io
  K --> F

  J -- "No" --> E1["Stop and return error with filename"]:::err

  F --> E

  X --> Z[End]:::op
  E1 --> Z

  %% Annotations
  B -.-> N1["Ledger enables exactly-once per file"]:::note
  C -.-> N2["Only top-level .sql files considered"]:::note
  I -.-> N3["Idempotency header prevents duplicates on retry"]:::note
  E1 -.-> N4["Previously applied steps remain committed"]:::note
